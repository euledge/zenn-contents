---
title: "RDBã§ã‚¹ã‚­ãƒ¼ãƒãƒ¬ã‚¹ãªæŸ”è»Ÿæ€§ã‚’ï¼å‹å®‰å…¨ãªEAVãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¨­è¨ˆã¨å®Ÿè£…"
emoji: "ğŸ—ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["architecture", "database", "java", "sql"]
published: false
---

# ã¯ã˜ã‚ã«

ã‚·ã‚¹ãƒ†ãƒ ã‚’é–‹ç™ºãƒ»é‹ç”¨ã—ã¦ã„ã‚‹ã¨ã€é¿ã‘ã¦é€šã‚Œãªã„ã®ãŒã€Œæ‹ ç‚¹ã‚„å“ç›®ã”ã¨ã«ã€ã¡ã‚‡ã£ã¨ã ã‘ç®¡ç†ã—ãŸã„é …ç›®ãŒé•ã†ã€ã¨ã„ã†å•é¡Œã§ã™ã€‚

* ã€Œé£Ÿå“å€‰åº«ï¼ˆæ‹ ç‚¹Aï¼‰ã§ã¯ã€è³å‘³æœŸé™ã€ãŒå¿…é ˆã ãŒã€ã‚¢ãƒ‘ãƒ¬ãƒ«å€‰åº«ï¼ˆæ‹ ç‚¹Bï¼‰ã§ã¯ä¸è¦ã€
* ã€Œç‰¹å®šã®å“ç›®ã ã‘ã«ã€æ´—æ¿¯è¡¨ç¤ºã€ã‚„ã€ç´ ææ§‹æˆã€ãªã©ã®ãƒ¡ã‚¿æƒ…å ±ã‚’è¿½åŠ ã—ãŸã„ãŒã€ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ï¼ˆDDLï¼‰ã‚’å¤‰ãˆã¦ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã®ã¯æ™‚é–“ãŒã‹ã‹ã‚‹â€¦â€¦ã€

ã“ã†ã—ãŸèª²é¡Œã‚’è§£æ±ºã™ã‚‹æ‰‹æ³•ã¨ã—ã¦ã€ **EAVï¼ˆEntity-Attribute-Valueï¼‰ãƒ‘ã‚¿ãƒ¼ãƒ³** ãŒã‚ã‚Šã¾ã™ã€‚ã—ã‹ã—ã€EAVã¯ã€Œä½•ã§ã‚‚æ–‡å­—åˆ—ã§ä¿å­˜ã—ã¦ã—ã¾ã„ã€å‹å®‰å…¨æ€§ãŒå¤±ã‚ã‚Œã‚‹ã€ã¨ã„ã†ç†ç”±ã‹ã‚‰ã€ä¸€ç¨®ã®ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’ä¾‹ã«ã€ **DBãƒ¬ãƒ™ãƒ«ã§ã®å‹å®‰å…¨ã¨æ•´åˆæ€§ã‚’ä¿ã¡ã¤ã¤ã€æŸ”è»Ÿæ€§ã‚’ç¢ºä¿ã™ã‚‹ã€Œå‹å®‰å…¨ãªEAVã€** ã®è¨­è¨ˆã¨å®Ÿè£…ä¾‹ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚

---

## 1. èª²é¡Œï¼šãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©å¤‰æ›´ã®ã‚³ã‚¹ãƒˆã‚’ã©ã†ä¸‹ã’ã‚‹ã‹ï¼Ÿ

åœ¨åº«ç®¡ç†ãªã©ã®ç¾å ´ã§ã¯ã€æ‹ ç‚¹ï¼ˆå€‰åº«ï¼‰ã‚„æ‰±ã†å“ç›®ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ç®¡ç†é …ç›®ãŒå¾®å¦™ã«ç•°ãªã‚‹ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚
ãã®ãŸã³ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ‹¡å¼µã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†ãƒ“ãƒ«ãƒ‰ãƒ»å†ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã®ã¯ã‚³ã‚¹ãƒˆãŒé«˜ãã€æŸ”è»Ÿæ€§ã«æ¬ ã‘ã¾ã™ã€‚

ãã“ã§ã€ **ã€Œã‚¹ã‚­ãƒ¼ãƒã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãªãã€å‹•çš„ã«å±æ€§ã‚’è¿½åŠ ãƒ»ç®¡ç†ã§ãã‚‹ã€** ã¨ã„ã†EAVã®ãƒ¡ãƒªãƒƒãƒˆã‚’ã€RDBã®å …ç‰¢æ€§ã‚’æãªã‚ãšã«å–ã‚Šå…¥ã‚Œã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã—ãŸã€‚

---

## 2. DBè¨­è¨ˆã®å·¥å¤«ï¼šå…±é€šãƒ†ãƒ¼ãƒ–ãƒ«ã¨å‹å®‰å…¨ãªEAVãƒ†ãƒ¼ãƒ–ãƒ«

å…¨ã¦ã®åœ¨åº«å“ç›®ã§å…±é€šã—ã¦å¿…è¦ãªé …ç›®ï¼ˆåŸºå¹¹å±æ€§ï¼‰ã¯é€šå¸¸ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«å®šç¾©ã—ã€æ‹ ç‚¹ã‚„ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ç•°ãªã‚‹é …ç›®ã®ã¿ã‚’EAVãƒ†ãƒ¼ãƒ–ãƒ«ã§ç®¡ç†ã—ã¾ã™ã€‚

### ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹åœ¨åº«ãƒ†ãƒ¼ãƒ–ãƒ«
å…¥åº«æ—¥æ™‚ã‚„å‡ºåº«äºˆå®šæ—¥æ™‚ãªã©ã¯ã€ã©ã®å€‰åº«ã§ã‚‚å…±é€šã®é …ç›®ã¨ã—ã¦å®šç¾©ã—ã¾ã™ã€‚

```sql
CREATE TABLE inventory_item (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    item_name VARCHAR(255) NOT NULL,
    arrival_date_time DATETIME NOT NULL,          -- å…¥åº«æ—¥æ™‚ï¼ˆå…±é€šï¼‰
    scheduled_departure_date_time DATETIME,       -- å‡ºåº«äºˆå®šæ—¥æ™‚ï¼ˆå…±é€šï¼‰
    warehouse_type VARCHAR(20) NOT NULL           -- 'FOOD', 'APPAREL' ãªã©
);
```

### å€‹åˆ¥å±æ€§ãƒ†ãƒ¼ãƒ–ãƒ« (EAV)
å…±é€šãƒ†ãƒ¼ãƒ–ãƒ«ã§ã¯æŒã¡ãã‚Œãªã„å±æ€§ã®ã¿ã‚’ã“ã¡ã‚‰ã«åˆ‡ã‚Šå‡ºã—ã¾ã™ã€‚

### MySQLã§ã®å®Ÿè£…ä¾‹
ï¼ˆâ€»æ³¨æ„ï¼š`CHECK` åˆ¶ç´„ãŒå®Ÿéš›ã«æ©Ÿèƒ½ã™ã‚‹ã®ã¯ MySQL 8.0.16 ä»¥é™ã§ã™ï¼‰

```sql
CREATE TABLE inventory_item_attribute (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    inventory_item_id BIGINT NOT NULL, -- inventory_item ã¸ã®å¤–éƒ¨ã‚­ãƒ¼
    attribute_name VARCHAR(255) NOT NULL,

    -- ã©ã®å‹ã¨ã—ã¦æ‰±ã†ã‹ã‚’æŒ‡å®š
    value_type ENUM('STRING','NUMBER','DATE','DATETIME','BOOLEAN') NOT NULL,
    
    -- å‹ã”ã¨ã«ã‚«ãƒ©ãƒ ã‚’åˆ†ã‘ã‚‹
    attribute_value_string VARCHAR(255),
    attribute_value_number DECIMAL(10,3),
    attribute_value_date DATE,
    attribute_value_datetime DATETIME,
    attribute_value_boolean BOOLEAN,

    -- ã€é‡è¦ã€‘CHECKåˆ¶ç´„ã«ã‚ˆã‚‹æ•´åˆæ€§ã®ä¿è¨¼
    CONSTRAINT chk_attribute_consistency CHECK (
        (value_type = 'STRING'   AND attribute_value_string IS NOT NULL   AND attribute_value_number IS NULL AND attribute_value_date IS NULL AND attribute_value_datetime IS NULL AND attribute_value_boolean IS NULL) OR
        (value_type = 'NUMBER'   AND attribute_value_number IS NOT NULL   AND attribute_value_string IS NULL AND attribute_value_date IS NULL AND attribute_value_datetime IS NULL AND attribute_value_boolean IS NULL) OR
        (value_type = 'DATE'     AND attribute_value_date IS NOT NULL     AND attribute_value_string IS NULL AND attribute_value_number IS NULL AND attribute_value_datetime IS NULL AND attribute_value_boolean IS NULL) OR
        (value_type = 'DATETIME' AND attribute_value_datetime IS NOT NULL AND attribute_value_string IS NULL AND attribute_value_number IS NULL AND attribute_value_date IS NULL AND attribute_value_boolean IS NULL) OR
        (value_type = 'BOOLEAN'  AND attribute_value_boolean IS NOT NULL  AND attribute_value_string IS NULL AND attribute_value_number IS NULL AND attribute_value_date IS NULL AND attribute_value_datetime IS NULL)
    ),
    FOREIGN KEY (inventory_item_id) REFERENCES inventory_item(id)
);
```

### PostgreSQL / æ¨™æº–SQLæº–æ‹ ã®å®Ÿè£…ä¾‹ï¼ˆãƒãƒ¼ã‚¿ãƒ–ãƒ«ï¼‰
ä»–ã®DBï¼ˆPostgreSQL, SQL Server, Oracleãªã©ï¼‰ã¸ã®ç§»æ¤æ€§ã‚’è€ƒæ…®ã™ã‚‹å ´åˆã¯ã€æ¨™æº–SQLã® `IDENTITY` æ§‹æ–‡ã‚„ `CHECK` åˆ¶ç´„ã‚’çµ„ã¿åˆã‚ã›ã¦ã€ç‰¹å®šã®DBãƒ™ãƒ³ãƒ€ãƒ¼ã«ä¾å­˜ã—ãªã„å½¢ã§å®šç¾©ã—ã¾ã™ã€‚

```sql
CREATE TABLE inventory_item_attribute (
    -- æ¨™æº–SQLæº–æ‹ ã®è‡ªå‹•æ¡ç•ª
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    inventory_item_id BIGINT NOT NULL,
    attribute_name VARCHAR(255) NOT NULL,

    -- ENUMã®ä»£ã‚ã‚Šã«VARCHAR + CHECKåˆ¶ç´„ã‚’ä½¿ç”¨
    value_type VARCHAR(20) NOT NULL,
    
    attribute_value_string VARCHAR(255),
    attribute_value_number DECIMAL(10,3),
    attribute_value_date DATE,
    attribute_value_datetime TIMESTAMP, -- æ±ç”¨çš„ãªæ™‚é–“å‹
    attribute_value_boolean BOOLEAN,

    -- å€¤ã®ç¨®é¡ã®åˆ¶é™
    CONSTRAINT chk_value_type CHECK (value_type IN ('STRING','NUMBER','DATE','DATETIME','BOOLEAN')),
    
    -- æ•´åˆæ€§ã®ä¿è¨¼
    CONSTRAINT chk_attribute_consistency CHECK (
        (value_type = 'STRING'   AND attribute_value_string IS NOT NULL   AND attribute_value_number IS NULL AND attribute_value_date IS NULL AND attribute_value_datetime IS NULL AND attribute_value_boolean IS NULL) OR
        (value_type = 'NUMBER'   AND attribute_value_number IS NOT NULL   AND attribute_value_string IS NULL AND attribute_value_date IS NULL AND attribute_value_datetime IS NULL AND attribute_value_boolean IS NULL) OR
        (value_type = 'DATE'     AND attribute_value_date IS NOT NULL     AND attribute_value_string IS NULL AND attribute_value_number IS NULL AND attribute_value_datetime IS NULL AND attribute_value_boolean IS NULL) OR
        (value_type = 'DATETIME' AND attribute_value_datetime IS NOT NULL AND attribute_value_string IS NULL AND attribute_value_number IS NULL AND attribute_value_date IS NULL AND attribute_value_boolean IS NULL) OR
        (value_type = 'BOOLEAN'  AND attribute_value_boolean IS NOT NULL  AND attribute_value_string IS NULL AND attribute_value_number IS NULL AND attribute_value_date IS NULL AND attribute_value_datetime IS NULL)
    )
);
```

### 2.1. ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ä¾‹
å®Ÿéš›ã«ã©ã®ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ãŒä¿æŒã•ã‚Œã¦ã„ã‚‹ã‹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

#### inventory_item (å…±é€šãƒ†ãƒ¼ãƒ–ãƒ«)
| id | item_name | arrival_date_time | warehouse_type |
| :--- | :--- | :--- | :--- |
| 1 | å†·å‡ã¾ãã‚ | 2026-02-01 10:00:00 | FOOD |
| 2 | ç¶¿Tã‚·ãƒ£ãƒ„ | 2026-02-02 14:30:00 | APPAREL |

#### inventory_item_attribute (EAVãƒ†ãƒ¼ãƒ–ãƒ«)
`CHECK` åˆ¶ç´„ã«ã‚ˆã‚Šã€`value_type` ã«å¿œã˜ãŸ1ã¤ã®ã‚«ãƒ©ãƒ ã ã‘ã«å€¤ãŒå…¥ã‚Šã€ä»–ã¯ `NULL` ã«ãªã‚Šã¾ã™ã€‚

| inventory_item_id | attribute_name | value_type | val_string | val_number | val_date | val_boolean |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 1 (å†·å‡ã¾ãã‚) | EXPIRY_DATE | DATE | NULL | NULL | 2026-08-31 | NULL |
| 1 (å†·å‡ã¾ãã‚) | STORAGE_TEMP | NUMBER | NULL | -18.5 | NULL | NULL |
| 2 (ç¶¿Tã‚·ãƒ£ãƒ„) | MATERIAL | STRING | Cotton 100% | NULL | NULL | NULL |
| 2 (ç¶¿Tã‚·ãƒ£ãƒ„) | WASHABLE | BOOLEAN | NULL | NULL | NULL | 1 (True) |

### 2.2. ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼šJOINã«ã‚ˆã‚‹ä¸€æ‹¬å–å¾—
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’å†æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«ã€ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã¨å±æ€§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ `LEFT JOIN` ã§ä¸€æ‹¬å–å¾—ã™ã‚‹SQLä¾‹ã§ã™ã€‚

```sql
SELECT
    i.id,
    i.item_name,
    i.arrival_date_time,
    i.scheduled_departure_date_time,
    i.warehouse_type,
    a.attribute_name,
    a.value_type,
    a.attribute_value_string,
    a.attribute_value_number,
    a.attribute_value_date,
    a.attribute_value_datetime,
    a.attribute_value_boolean
FROM
    inventory_item i
LEFT JOIN
    inventory_item_attribute a ON i.id = a.inventory_item_id
WHERE
    i.id = 1; -- ç‰¹å®šã®åœ¨åº«å“ç›®ã‚’å–å¾—
```

ã“ã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€1ã¤ã®åœ¨åº«å“ç›®ã«å¯¾ã—ã¦å±æ€§ã®æ•°ã ã‘è¡ŒãŒè¿”ã£ã¦ãã¾ã™ã€‚ã“ã‚Œã‚‰ã®è¡Œã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®ãƒãƒƒãƒ‘ãƒ¼ï¼ˆå‰è¿°ã® `toDomain`ï¼‰ã§é›†ç´„ã—ã€1ã¤ã® `InventoryItem` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

### 2.3. CASEå¼ã«ã‚ˆã‚‹å€¤ã®é›†ç´„è¡¨ç¤º
DBä¸Šã§å±æ€§å€¤ã‚’ç¢ºèªã—ãŸã„å ´åˆã‚„ã€æ–‡å­—åˆ—ã¨ã—ã¦ä¸€å¾‹ã«æ‰±ã„ãŸã„å ´åˆã¯ã€`CASE` å¼ã‚’ä½¿ã£ã¦å€¤ã‚’é›†ç´„ã§ãã¾ã™ã€‚

```sql
SELECT
    i.item_name,
    a.attribute_name,
    CASE a.value_type
        WHEN 'STRING'   THEN a.attribute_value_string
        WHEN 'NUMBER'   THEN CAST(a.attribute_value_number AS CHAR)
        WHEN 'DATE'     THEN CAST(a.attribute_value_date AS CHAR)
        WHEN 'DATETIME' THEN CAST(a.attribute_value_datetime AS CHAR)
        WHEN 'BOOLEAN'  THEN IF(a.attribute_value_boolean, 'Yes', 'No')
        ELSE 'Unknown'
    END AS display_value
FROM
    inventory_item i
JOIN
    inventory_item_attribute a ON i.id = a.inventory_item_id;
```

#### å®Ÿè¡Œçµæœã‚¤ãƒ¡ãƒ¼ã‚¸
| item_name | attribute_name | display_value |
| :--- | :--- | :--- |
| å†·å‡ã¾ãã‚ | EXPIRY_DATE | 2026-08-31 |
| å†·å‡ã¾ãã‚ | STORAGE_TEMP | -18.5 |
| ç¶¿Tã‚·ãƒ£ãƒ„ | MATERIAL | Cotton 100% |
| ç¶¿Tã‚·ãƒ£ãƒ„ | WASHABLE | Yes |

### ã“ã®è¨­è¨ˆã®ãƒ¡ãƒªãƒƒãƒˆ
1.  **å‹å®‰å…¨**: æ•°å€¤ã‚„æ—¥ä»˜ã‚’é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿å‹ã§ä¿å­˜ã§ãã‚‹ãŸã‚ã€DBã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ãã€ç¯„å›²æ¤œç´¢ãªã©ã‚‚åŠ¹ç‡çš„ã§ã™ã€‚
2.  **æ•´åˆæ€§ (æ’ä»–åˆ¶å¾¡)**: `CHECK` åˆ¶ç´„ã«ã‚ˆã‚Šã€ã€Œå‹ã¯æ•°å€¤ãªã®ã«æ–‡å­—åˆ—ã‚«ãƒ©ãƒ ã«ã‚‚å€¤ãŒå…¥ã£ã¦ã„ã‚‹ã€ã¨ã„ã£ãŸçŸ›ç›¾ã‚’DBå±¤ã§é˜²ã’ã¾ã™ã€‚ã™ã¹ã¦ã®å‹å°‚ç”¨ã‚«ãƒ©ãƒ ã«ã¤ã„ã¦ `IS NULL` ã‚’æ˜ç¤ºã™ã‚‹ã“ã¨ã§ã€**ã€Œ1ã¤ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã¯å¿…ãš1ã¤ã®å€¤ã ã‘ãŒã€æ­£ã—ã„å‹ã®ã‚«ãƒ©ãƒ ã«å­˜åœ¨ã™ã‚‹ã€**çŠ¶æ…‹ã‚’å¼·åˆ¶ã—ã¦ã„ã¾ã™ã€‚
3.  **æ¤œç´¢æ€§**: å‹ãŒåˆ†ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€ç‰¹å®šã®å‹ã«çµã£ãŸã‚¯ã‚¨ãƒªãŒæ›¸ãã‚„ã™ããªã‚Šã¾ã™ã€‚

ç‰¹ã« `CHECK` åˆ¶ç´„ã«ã‚ˆã‚‹æ’ä»–åˆ¶å¾¡ã¯é‡è¦ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒã‚°ã‚„æ‰‹å‹•ã®SQLæ“ä½œã«ã‚ˆã£ã¦ã€1ã¤ã®å±æ€§ã«å¯¾ã—ã¦è¤‡æ•°ã®å‹ã®å€¤ãŒæ··åœ¨ã—ã¦ã—ã¾ã†ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã€Œæ±šã‚Œã‚‹ã€ï¼‰ãƒªã‚¹ã‚¯ã‚’å®Œå…¨ã«æ’é™¤ã§ãã¾ã™ã€‚

---

## 3. å®Ÿè£…ã®æ§‹é€ ï¼šãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã‚’æ±šã•ãªã„

DBãŒç‰¹æ®Šãªæ§‹é€ ï¼ˆEAVï¼‰ã‚’ã—ã¦ã„ã‚‹ã‹ã‚‰ã¨ã„ã£ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¾ã§ãã‚Œã‚’æ„è­˜ã™ã‚‹ã®ã¯é¿ã‘ãŸã„ã¨ã“ã‚ã§ã™ã€‚

### 3.1. ã‚¤ãƒ³ãƒ•ãƒ©å±¤ (DTO / Entity)
JPAãªã©ã§æ‰±ã†éš›ã¯ã€å‹åˆ¥ã®ã‚«ãƒ©ãƒ ã‚’ `@Embedded` ã§ã¾ã¨ã‚ãŸã‚Šã€åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’æ´»ç”¨ã—ã¦å…±é€šåŒ–ã—ã¾ã™ã€‚

### 3.2. ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã¸ã®æŠ½è±¡åŒ–
ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã§ã¯ã€æŠ€è¡“çš„ãªEAVæ§‹é€ ã‚’éš è”½ã™ã‚‹ãŸã‚ã«ã€**Sealed Interface** ã¨å®Ÿè£…ã‚¯ãƒ©ã‚¹ã‚’æ´»ç”¨ã—ã¾ã™ã€‚å±æ€§ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å°‚ç”¨ã®ã‚¯ãƒ©ã‚¹ã«ã‚«ãƒ—ã‚»ãƒ«åŒ–ã™ã‚‹ã“ã¨ã§ã€åˆ©ç”¨å´ã¯å‹å®‰å…¨ã«å€¤ã‚’æ‰±ãˆã¾ã™ã€‚

```java
public sealed interface AttributeValue {
    /**
     * è¡¨ç¤ºç”¨ã«æ•´å½¢ã•ã‚ŒãŸå€¤ã‚’å–å¾—ã™ã‚‹
     */
    String displayValue();

    record StringValue(String value) implements AttributeValue {
        @Override public String displayValue() { return value; }
    }
    record NumberValue(BigDecimal value) implements AttributeValue {
        @Override public String displayValue() { return value.toPlainString(); }
    }
    record DateValue(LocalDate value) implements AttributeValue {
        @Override public String displayValue() { return value.toString(); }
    }
    record DateTimeValue(LocalDateTime value) implements AttributeValue {
        @Override public String displayValue() { return value.toString(); }
    }
    record BooleanValue(Boolean value) implements AttributeValue {
        @Override public String displayValue() { return value ? "Yes" : "No"; }
    }
}

// å‹•çš„å±æ€§ã®ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹
public interface ExpandAttribute {
    Map<String, AttributeValue> toMap();

    /**
     * å…¨ã¦ã®å±æ€§ã‚’è¡¨ç¤ºç”¨ã«æ•´å½¢ã—ã¦å–å¾—ã™ã‚‹
     * ä¾‹: "EXPIRY_DATE: 2026-02-15, TEMPERATURE: -18.5"
     */
    default String toDisplayString() {
        return toMap().entrySet().stream()
            .map(e -> e.getKey() + ": " + e.getValue().displayValue())
            .collect(Collectors.joining(", "));
    }
}

// é£Ÿå“å€‰åº«ç”¨ã®å±æ€§ã‚¯ãƒ©ã‚¹
public record FoodInventoryAttribute(Map<String, AttributeValue> values) implements ExpandAttribute {
    @Override public Map<String, AttributeValue> toMap() { return values; }

    public Optional<LocalDate> expiryDate() {
        return Optional.ofNullable(values.get("EXPIRY_DATE"))
            .filter(v -> v instanceof AttributeValue.DateValue)
            .map(v -> ((AttributeValue.DateValue) v).value());
    }
}

// ã‚¢ãƒ‘ãƒ¬ãƒ«å€‰åº«ç”¨ã®å±æ€§ã‚¯ãƒ©ã‚¹
public record ApparelInventoryAttribute(Map<String, AttributeValue> values) implements ExpandAttribute {
    @Override public Map<String, AttributeValue> toMap() { return values; }

    public Optional<String> material() {
        return Optional.ofNullable(values.get("MATERIAL"))
            .filter(v -> v instanceof AttributeValue.StringValue)
            .map(v -> ((AttributeValue.StringValue) v).value());
    }
}
```

### 3.3. ãƒãƒƒãƒ”ãƒ³ã‚°å‡¦ç†
DBã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã¸å¤‰æ›ã—ã¾ã™ã€‚ã“ã“ã§ã¯ `switch` æ–‡ã‚’ä½¿ã‚ãšã€ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ã‚’Mapã«å®šç¾©ã™ã‚‹ã“ã¨ã§ã€å®£è¨€çš„ã§æ‹¡å¼µæ€§ã®é«˜ã„ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

```java
// å‹ã”ã¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©
private static final Map<String, Function<InventoryItemAttributeDto, AttributeValue>> MAPPERS = Map.of(
    "STRING",   dto -> new AttributeValue.StringValue(dto.getAttributeValueString()),
    "NUMBER",   dto -> new AttributeValue.NumberValue(dto.getAttributeValueNumber()),
    "DATE",     dto -> new AttributeValue.DateValue(dto.getAttributeValueDate()),
    "DATETIME", dto -> new AttributeValue.DateTimeValue(dto.getAttributeValueDatetime()),
    "BOOLEAN",  dto -> new AttributeValue.BooleanValue(dto.getAttributeValueBoolean())
);

/**
 * æ±ç”¨çš„ãªãƒãƒƒãƒ”ãƒ³ã‚°ãƒ¡ã‚½ãƒƒãƒ‰
 * @param factory å…·è±¡å±æ€§ã‚¯ãƒ©ã‚¹ã®ç”Ÿæˆé–¢æ•°ï¼ˆFoodInventoryAttribute::new ãªã©ï¼‰
 */
public static <T extends ExpandAttribute> InventoryItem<T> toDomain(
        InventoryItemDto itemDto, 
        List<InventoryItemAttributeDto> attrDtos,
        Function<Map<String, AttributeValue>, T> factory) {
    
    // 1. å±æ€§ãƒªã‚¹ãƒˆã‚’Mapã«å¤‰æ›ï¼ˆå®šç¾©æ¸ˆã¿ã®MAPPERSã‚’ä½¿ç”¨ï¼‰
    Map<String, AttributeValue> values = attrDtos.stream()
        .collect(Collectors.toMap(
            InventoryItemAttributeDto::getAttributeName,
            dto -> Optional.ofNullable(MAPPERS.get(dto.getValueType()))
                .map(mapper -> mapper.apply(dto))
                .orElseThrow(() -> new IllegalArgumentException("ä¸æ˜ãªå‹: " + dto.getValueType()))
        ));

    // 2. factory(ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‚ç…§)ã‚’ä½¿ç”¨ã—ã¦ã€æŒ‡å®šã•ã‚ŒãŸå‹Tã®å±æ€§ã‚¯ãƒ©ã‚¹ã‚’ç”Ÿæˆ
    T attributes = factory.apply(values);

    return new InventoryItem<>(
        itemDto.getId(),
        itemDto.getItemName(),
        itemDto.getArrivalDateTime(),
        itemDto.getScheduledDepartureDateTime(),
        attributes
    );
}

// åˆ©ç”¨ä¾‹ï¼šå‘¼ã³å‡ºã—å´ã§ã€Œã©ã®å‹ã¨ã—ã¦ä½œã‚ŠãŸã„ã‹ã€ã‚’ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å‚ç…§ã§æ¸¡ã™
InventoryItem<FoodInventoryAttribute> foodItem = 
    toDomain(itemDto, attrDtos, FoodInventoryAttribute::new);

InventoryItem<ApparelInventoryAttribute> apparelItem = 
    toDomain(itemDto, attrDtos, ApparelInventoryAttribute::new);
```

ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šã€æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿å‹ãŒå¢—ãˆãŸéš›ã¯ `MAPPERS` ã«å®šç¾©ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§æ¸ˆã¿ã€ã¾ãŸæ–°ã—ã„å€‰åº«ç¨®åˆ¥ãŒå¢—ãˆãŸéš›ã‚‚ `toDomain` ãƒ¡ã‚½ãƒƒãƒ‰è‡ªä½“ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚ªãƒ¼ãƒ—ãƒ³ãƒ»ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ã®åŸå‰‡ï¼‰ã€‚å‘¼ã³å‡ºã—å´ã®å‹æŒ‡å®šã«é€£å‹•ã—ãŸã€ã‚¯ãƒªãƒ¼ãƒ³ã§æ‹¡å¼µæ€§ã®é«˜ã„ãƒãƒƒãƒ”ãƒ³ã‚°ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### 3.4. å…±é€šã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ `InventoryItem`
å…¨ã¦ã®åœ¨åº«å“ç›®ã«å…±é€šã™ã‚‹é …ç›®ã¯ `InventoryItem` ã‚¯ãƒ©ã‚¹ã§ä¿æŒã—ã€å‹•çš„å±æ€§ã®éƒ¨åˆ†ã‚’ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã§æŠ½è±¡åŒ–ã—ã¾ã™ã€‚

```java
public record InventoryItem<T extends ExpandAttribute>(
    Long id,
    String itemName,
    LocalDateTime arrivalDateTime,
    LocalDateTime scheduledDepartureDateTime,
    T attributes // å…·è±¡å±æ€§ã‚¯ãƒ©ã‚¹ï¼ˆFoodInventoryAttributeãªã©ï¼‰ãŒå…¥ã‚‹
) {
    public String summary() {
        return String.format("[%d] %s (å…¥åº«: %s) å±æ€§: {%s}", 
            id, itemName, arrivalDateTime, attributes.toDisplayString());
    }
}
```

### 3.5. åˆ©ç”¨ä¾‹ï¼šå‹å®‰å…¨ãªå±æ€§ã‚¢ã‚¯ã‚»ã‚¹
ã“ã®æ§‹æˆã«ã‚ˆã‚Šã€å…±é€šã®åœ¨åº«ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ã¨ã€å€‰åº«å›ºæœ‰ã®å±æ€§æ“ä½œã‚’ä¸¡ç«‹ã§ãã¾ã™ã€‚

```java
public class InventoryManagementService {
    public void processFoodItem(InventoryItem<FoodInventoryAttribute> foodItem) {
        System.out.println(foodItem.summary());
        
        // å±æ€§ã‚¯ãƒ©ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’é€šã˜ã¦ã€å‹å®‰å…¨ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
        foodItem.attributes().expiryDate().ifPresent(date -> {
            if (date.isBefore(LocalDate.now())) {
                System.out.println("è­¦å‘Šï¼šæœŸé™åˆ‡ã‚Œã§ã™ï¼");
            }
        });
    }

    public void processApparelItem(InventoryItem<ApparelInventoryAttribute> apparelItem) {
        System.out.println(apparelItem.summary());
        
        // ã‚¢ãƒ‘ãƒ¬ãƒ«å›ºæœ‰ã®å±æ€§ï¼ˆç´ æï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹
        apparelItem.attributes().material().ifPresent(m -> 
            System.out.println("ç´ æ: " + m));
    }
}
```

---

## 4. ã¾ã¨ã‚

EAVãƒ‘ã‚¿ãƒ¼ãƒ³ã¯è«¸åˆƒã®å‰£ã§ã™ãŒã€ä»¥ä¸‹ã®å·¥å¤«ã‚’å‡ã‚‰ã™ã“ã¨ã§éå¸¸ã«å¼·åŠ›ãªæ­¦å™¨ã«ãªã‚Šã¾ã™ã€‚

*   **DBå±¤**: MySQLã®ç‹¬è‡ªæ©Ÿèƒ½ã‚„ã€æ¨™æº–SQLã® `CHECK` åˆ¶ç´„ã‚’ä½¿ã„ã€å‹ã”ã¨ã«ã‚«ãƒ©ãƒ ã‚’åˆ†ã‘ã¦æ•´åˆæ€§ã‚’æ‹…ä¿ã™ã‚‹ã€‚
*   **ã‚¢ãƒ—ãƒªå±¤**: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ãƒãƒƒãƒ‘ãƒ¼ã‚’æ´»ç”¨ã—ã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‹ã‚‰EAVã®æ§‹é€ ã‚’éš”é›¢ã™ã‚‹ã€‚

ã€ŒRDBã®å …ç‰¢ã•ã€ã¨ã€Œã‚¹ã‚­ãƒ¼ãƒãƒ¬ã‚¹ãªæŸ”è»Ÿæ€§ã€ã‚’ä¸¡ç«‹ã•ã›ãŸã„æ™‚ã®é¸æŠè‚¢ã¨ã—ã¦ã€ãœã²æ¤œè¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
